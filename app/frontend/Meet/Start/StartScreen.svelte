<hbox flex class="main">
  <vbox flex class="actions-container">
    <vbox class="actions">
      {#if $selectedPerson}
        <Button label={$t`Call ${$selectedPerson.name}`} onClick={() => callSelected($selectedPerson)} errorCallback={showError} classes="call-person secondary">
          <PersonPicture slot="icon" person={$selectedPerson} size={24} />
        </Button>
      {/if}
      <Button label={$t`Start an ad-hoc meeting`} icon={VideoIcon} onClick={startAdHocMeeting} errorCallback={showError} classes="secondary" />
      <Button label={$t`Plan a meeting`} icon={AddToCalendarIcon} classes="secondary" iconSize="14px" />
      <hbox>
        <input class="meeting-link" type="url" bind:value={conferenceURL}
          placeholder={$t`Enter meeting link to join`}
          on:input={() => errorMsg = null}
          on:paste={() => catchErrors(joinURLPasted, showError)}
          on:keydown={event => onKeyEnter(event, () => catchErrors(joinByURL, showError))} />
        <Button label={$t`Join`} classes="secondary"
          disabled={!conferenceURL}
          onClick={() => joinByURL(conferenceURL)}
          errorCallback={showError} />
      </hbox>
    </vbox>
    <vbox class="error">
      {#if errorMsg}
        <ErrorMessage bind:errorMessage={errorMsg} errorGravity={ErrorGravity.Error} />
      {/if}
    </vbox>
  </vbox>
  <vbox flex class="meetings">
    <vbox flex />
    <vbox flex class="upcoming">
      <hbox class="title font-small">{$t`Today's next meetings`}</hbox>
      <MeetingList meetings={upcomingMeetings}>
        <div slot="emptyMsg" class="emptyMsg font-small">{$t`No meetings coming up`}</div>
      </MeetingList>
    </vbox>
    <vbox flex class="previous">
      <hbox class="title font-small">{$t`Previous meetings`}</hbox>
      <MeetingList meetings={previousMeetings}>
        <div slot="emptyMsg" class="emptyMsg font-small">{$t`No recent meetings`}</div>
      </MeetingList>
    </vbox>
    <vbox flex />
    <hbox class="test">
      <ExpandSection>
        <vbox class="buttons">
          {#if $selectedPerson}
            <Button label={$t`Test incoming call`} icon={VideoIcon} onClick={() => testIncoming($selectedPerson)} errorCallback={showError} classes="secondary" />
          {/if}
          <Button label={$t`Start a fake meeting`} icon={VideoIcon} onClick={startFakeMeeting} errorCallback={showError} classes="secondary" />
        </vbox>
      </ExpandSection>
    </hbox>
  </vbox>
</hbox>
{#if $appGlobal.isMobile}
  <StartBarM selectedAccount={appGlobal.meetAccounts.first} />
{/if}

<script lang="ts">
  import { startAdHocMeeting, callSelected, joinByURL, startFakeMeeting, testIncoming, createMustangMeetAccountIfPossible } from "./start";
  import { selectedPerson } from "../../Contacts/Person/Selected";
  import { appGlobal } from "../../../logic/app";
  import MeetingList from "./MeetingList.svelte";
  import StartBarM from "./StartBarM.svelte";
  import PersonPicture from "../../Contacts/Person/PersonPicture.svelte";
  import ExpandSection from "../../Shared/ExpandSection.svelte";
  import ErrorMessage, { ErrorGravity } from "../../Shared/ErrorMessage.svelte";
  import Button from "../../Shared/Button.svelte";
  import VideoIcon from 'lucide-svelte/icons/video';
  import AddToCalendarIcon from "lucide-svelte/icons/calendar-plus";
  import { t } from "../../../l10n/l10n";
  import { catchErrors, logError } from "../../Util/error";
  import { onKeyEnter } from "../../Util/util";
  import { sleep } from "../../../logic/util/util";
  import { onMount } from "svelte";
  import { meetMustangApp } from "../MeetMustangApp";
  import { selectedApp } from "../../AppsBar/selectedApp";

  const now = new Date();
  const maxUpcoming = new Date();
  maxUpcoming.setHours(23); // today
  maxUpcoming.setMinutes(59);
  const maxPrevious = new Date();
  maxPrevious.setDate(maxPrevious.getDate() - 14); // last 14 days
  const upcomingMeetings = appGlobal.calendarEvents.filterObservable(event => event.startTime > now && event.startTime < maxUpcoming);
  const previousMeetings = appGlobal.calendarEvents.filterObservable(event => event.startTime < now && event.startTime > maxPrevious).reverse();

  let conferenceURL: string;

  async function joinURLPasted() {
    await sleep(0.1); // paste event fires before the input event, which clears the error
    await joinByURL(conferenceURL);
  }

  let errorMsg: string | null = null;

  function showError(ex: Error) {
    errorMsg = ex.message ?? ex + "";
    logError(ex);
  }

  $selectedApp = meetMustangApp;

  onMount(() => catchErrors(createMustangMeetAccountIfPossible));
</script>

<style>
  .actions-container {
    align-items: center;
    justify-content: center;
    flex: 2 0 0;
  }
  .actions :global(> *) {
    margin-block-start: 12px;
  }
  .actions :global(.call-person .avatar) {
    margin: -4px 0px;
  }
  .actions-container .error {
    position: absolute;
    bottom: 100px;
  }
  .test {
    align-self: end;
  }
  .test:not(:hover) :global(.buttons.top-right) {
    visibility: hidden;
  }
  .test .buttons {
    margin-block-end: 12px;
  }
  .test .buttons :global(> *) {
    margin-block-end: 12px;
  }
  .meeting-link {
    margin-inline-end: 4px;
  }
  .meetings {
    justify-content: center;
  }
  .upcoming,
  .previous {
    justify-content: center;
  }
  .title {
    font-weight: bold;
    margin-block-end: 12px;
  }
  .emptyMsg {
    color: grey;
  }
  @media (max-width: 800px) {
    .main {
      flex-direction: column;
    }
    .meetings {
      order: 1;
      align-items: center;
    }
    .actions-container {
      order: 2;
    }
  }
</style>
